### UPGRADE Instructions

If you have used this project prior to PHP 8.3 (or before 06/10/2024), you will need to manually migrate the database after the update.

```sql
ALTER TABLE audit_logs ALTER id TYPE UUID;
ALTER TABLE audit_logs ALTER id_user TYPE UUID;
ALTER TABLE audit_logs ALTER date TYPE TIMESTAMP(0) WITHOUT TIME ZONE;
ALTER TABLE audit_logs ALTER entity_type TYPE VARCHAR(255);
ALTER TABLE audit_logs ALTER task_name TYPE VARCHAR(255);
ALTER TABLE audit_logs ALTER records TYPE JSONB;
COMMENT ON COLUMN audit_logs.id IS '';
COMMENT ON COLUMN audit_logs.id_user IS '';
COMMENT ON COLUMN audit_logs.date IS '';
COMMENT ON COLUMN audit_logs.entity_type IS '';
COMMENT ON COLUMN audit_logs.task_name IS '';
COMMENT ON COLUMN audit_logs.records IS '';
ALTER TABLE cp_locations ALTER id DROP DEFAULT;
ALTER TABLE cp_locations ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE cp_package_virtual_machines ALTER id_package TYPE UUID;
COMMENT ON COLUMN cp_package_virtual_machines.id_package IS '';
ALTER TABLE cp_packages ALTER id_package TYPE UUID;
ALTER TABLE cp_packages ALTER package_type TYPE VARCHAR(512);
COMMENT ON COLUMN cp_packages.id_package IS '';
COMMENT ON COLUMN cp_packages.package_type IS '';
ALTER TABLE cp_solidcp_enterprise_dispatchers ALTER id DROP DEFAULT;
ALTER TABLE cp_solidcp_enterprise_dispatchers ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE cp_solidcp_hosting_plans ALTER id DROP DEFAULT;
ALTER TABLE cp_solidcp_hosting_plans ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE cp_package_assigned_scp_hosting_plans ALTER id_package TYPE UUID;
COMMENT ON COLUMN cp_package_assigned_scp_hosting_plans.id_package IS '';
ALTER TABLE cp_solidcp_hosting_space_os_templates ALTER id DROP DEFAULT;
ALTER TABLE cp_solidcp_hosting_space_os_templates ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE cp_solidcp_hosting_spaces ALTER id DROP DEFAULT;
ALTER TABLE cp_solidcp_hosting_spaces ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE cp_solidcp_servers ALTER id DROP DEFAULT;
ALTER TABLE cp_solidcp_servers ALTER id ADD GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE user_users ALTER id TYPE UUID;
ALTER TABLE user_users ALTER date TYPE TIMESTAMP(0) WITHOUT TIME ZONE;
ALTER TABLE user_users ALTER role TYPE VARCHAR(32);
ALTER TABLE user_users ALTER status TYPE VARCHAR(32);
COMMENT ON COLUMN user_users.id IS '';
COMMENT ON COLUMN user_users.date IS '';
COMMENT ON COLUMN user_users.role IS '';
COMMENT ON COLUMN user_users.status IS '';
```

Next, follow this article â€“ https://www.doctrine-project.org/projects/doctrine-dbal/en/4.0/how-to/postgresql-identity-migration.html.

You need to create the following function:

```php
CREATE OR REPLACE FUNCTION upgrade_serial_to_identity(tbl regclass, col name)
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
  colnum smallint;
  seqid oid;
  count int;
BEGIN
  -- find column number
  SELECT attnum INTO colnum FROM pg_attribute WHERE attrelid = tbl AND attname = col;
  IF NOT FOUND THEN
    RAISE EXCEPTION 'column does not exist';
  END IF;

  -- find sequence
     SELECT INTO seqid objid
    FROM pg_depend
    WHERE (refclassid, refobjid, refobjsubid) = ('pg_class'::regclass, tbl, colnum)
      AND classid = 'pg_class'::regclass AND objsubid = 0
      AND deptype = 'a';

  GET DIAGNOSTICS count = ROW_COUNT;
  IF count < 1 THEN
    RAISE EXCEPTION 'no linked sequence found';
  ELSIF count > 1 THEN
    RAISE EXCEPTION 'more than one linked sequence found';
  END IF;

  -- drop the default
  EXECUTE 'ALTER TABLE ' || tbl || ' ALTER COLUMN ' || quote_ident(col) || ' DROP DEFAULT';

  -- change the dependency between column and sequence to internal
  UPDATE pg_depend
    SET deptype = 'i'
    WHERE (classid, objid, objsubid) = ('pg_class'::regclass, seqid, 0)
      AND deptype = 'a';

  -- mark the column as identity column
  UPDATE pg_attribute
    SET attidentity = 'd'
    WHERE attrelid = tbl
      AND attname = col;
END;
$$;
```

And execute the following commands:

```sql
SELECT upgrade_serial_to_identity('cp_locations', 'id');
SELECT upgrade_serial_to_identity('cp_solidcp_enterprise_dispatchers', 'id');
SELECT upgrade_serial_to_identity('cp_solidcp_hosting_plans', 'id');
SELECT upgrade_serial_to_identity('cp_solidcp_hosting_space_os_templates', 'id');
SELECT upgrade_serial_to_identity('cp_solidcp_hosting_spaces', 'id');
SELECT upgrade_serial_to_identity('cp_solidcp_servers', 'id');
```
